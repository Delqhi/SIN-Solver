"""
Pentest API Endpoints
Specialized endpoints for Burp Suite, Metasploit, and OWASP ZAP.
"""
from fastapi import APIRouter, HTTPException, Depends, UploadFile, File, Header
from typing import Optional, Dict, Any
import logging

from app.services.solver_router import get_solver_router, UnifiedSolution
from app.services.burp_bridge import get_burp_bridge, BurpBridgeService
from app.core.config import settings

router = APIRouter()
logger = logging.getLogger(__name__)

async def verify_pentest_token(x_pentest_token: str = Header(None)):
    """
    Security Guardrail: Ensure the requester is an authorized researcher.
    """
    if x_pentest_token != settings.secret_key:
        logger.warning(f"ðŸš« [Pentest] Unauthorized access attempt with token: {x_pentest_token}")
        raise HTTPException(status_code=403, detail="Unauthorized Pentest Access")

@router.post("/solve", response_model=UnifiedSolution, dependencies=[Depends(verify_pentest_token)])
async def solve_pentest_captcha(
    request: Dict[str, Any],
    solver_router = Depends(get_solver_router)
):
    """
    Generic endpoint for Metasploit / ZAP.
    Expects JSON with 'image_base64' or 'question'.
    """
    image_base64 = request.get("image_base64")
    question = request.get("question")
    captcha_type = request.get("captcha_type", "auto")
    
    if image_base64:
        return await solver_router.solve_image(image_base64, captcha_type)
    elif question:
        return await solver_router.solve_text(question)
    else:
        raise HTTPException(status_code=400, detail="Missing image_base64 or question")

@router.post("/burp/solve", response_model=UnifiedSolution, dependencies=[Depends(verify_pentest_token)])
async def burp_solve(
    file: UploadFile = File(...),
    captcha_type: str = "auto",
    bridge: BurpBridgeService = Depends(get_burp_bridge)
):
    """
    Burp Suite specific endpoint. Handles raw image uploads.
    """
    content = await file.read()
    return await bridge.solve_burp_captcha(content, captcha_type)

@router.get("/status", dependencies=[Depends(verify_pentest_token)])
async def get_pentest_status():
    """
    Returns the status of the pentest-specific services.
    """
    return {
        "status": "active",
        "bridge": "connected",
        "mcp_plugins": "synced (Zimmer-08)",
        "security_level": "enterprise-grade-2026"
    }
