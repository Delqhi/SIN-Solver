#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

INFRA_SERVICES=(
    "infra-redis"
    "infra-postgres"
    "infra-steel"
    "infra-n8n"
)

APP_SERVICES=(
    "zimmer-13-api"
    "zimmer-02-chronos"
    "zimmer-04-opencode"
    "zimmer-08-qa"
    "zimmer-09-clawdbot"
    "zimmer-11-dashboard"
    "zimmer-12-evolution"
    "zimmer-14-worker"
    "zimmer-17-mcp"
    "zimmer-18-survey-worker"
    "zimmer-19-captcha-worker"
)

ALL_SERVICES=("${INFRA_SERVICES[@]}" "${APP_SERVICES[@]}")

print_header() {
    echo -e "\n${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë     üè† SIN-SOLVER: CEO EMPIRE STATE 2026                  ‚ïë${NC}"
    echo -e "${CYAN}‚ïë     Modular Container Control System                      ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
}

ensure_network() {
    if ! docker network ls --format '{{.Name}}' | grep -q "^haus-netzwerk$"; then
        echo -e "${BLUE}[INFO]${NC} Creating network: haus-netzwerk"
        docker network create --driver bridge --subnet 172.20.0.0/16 haus-netzwerk
    fi
}

start_all() {
    print_header
    ensure_network
    
    echo -e "${YELLOW}Starting Infrastructure...${NC}"
    for svc in "${INFRA_SERVICES[@]}"; do
        echo -e "${BLUE}‚Üí${NC} Starting $svc..."
        "$SCRIPT_DIR/${svc}.sh" start
    done
    
    echo -e "\n${YELLOW}Waiting for infrastructure health...${NC}"
    sleep 5
    
    echo -e "\n${YELLOW}Starting Application Services...${NC}"
    for svc in "${APP_SERVICES[@]}"; do
        echo -e "${BLUE}‚Üí${NC} Starting $svc..."
        "$SCRIPT_DIR/${svc}.sh" start
    done
    
    echo -e "\n${GREEN}‚úì All services started${NC}"
    show_status
}

stop_all() {
    print_header
    
    echo -e "${YELLOW}Stopping Application Services...${NC}"
    for svc in "${APP_SERVICES[@]}"; do
        echo -e "${BLUE}‚Üí${NC} Stopping $svc..."
        "$SCRIPT_DIR/${svc}.sh" stop 2>/dev/null || true
    done
    
    echo -e "\n${YELLOW}Stopping Infrastructure...${NC}"
    for svc in "${INFRA_SERVICES[@]}"; do
        echo -e "${BLUE}‚Üí${NC} Stopping $svc..."
        "$SCRIPT_DIR/${svc}.sh" stop 2>/dev/null || true
    done
    
    echo -e "\n${GREEN}‚úì All services stopped${NC}"
}

show_status() {
    print_header
    
    echo -e "${CYAN}Infrastructure:${NC}"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    printf "%-35s %-12s %-20s\n" "SERVICE" "STATUS" "PORTS"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    for svc in "${INFRA_SERVICES[@]}"; do
        local container=$(grep -o 'CONTAINER_NAME="[^"]*"' "$SCRIPT_DIR/${svc}.sh" | cut -d'"' -f2)
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            local ports=$(docker port "$container" 2>/dev/null | head -1 | awk '{print $3}' || echo "N/A")
            printf "%-35s ${GREEN}%-12s${NC} %-20s\n" "$svc" "‚óè RUNNING" "$ports"
        else
            printf "%-35s ${RED}%-12s${NC} %-20s\n" "$svc" "‚óã STOPPED" "-"
        fi
    done
    
    echo -e "\n${CYAN}Application Services:${NC}"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    printf "%-35s %-12s %-20s\n" "SERVICE" "STATUS" "PORTS"
    echo -e "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    for svc in "${APP_SERVICES[@]}"; do
        local container=$(grep -o 'CONTAINER_NAME="[^"]*"' "$SCRIPT_DIR/${svc}.sh" | cut -d'"' -f2)
        
        if [ "$svc" = "zimmer-14-worker" ]; then
            local running=$(docker ps --filter "name=Zimmer-14-Worker" --format '{{.Names}}' | wc -l | tr -d ' ')
            if [ "$running" -gt 0 ]; then
                printf "%-35s ${GREEN}%-12s${NC} %-20s\n" "$svc" "‚óè $running/5" "dynamic"
            else
                printf "%-35s ${RED}%-12s${NC} %-20s\n" "$svc" "‚óã STOPPED" "-"
            fi
        elif docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            local ports=$(docker port "$container" 2>/dev/null | head -1 | awk '{print $3}' || echo "N/A")
            printf "%-35s ${GREEN}%-12s${NC} %-20s\n" "$svc" "‚óè RUNNING" "$ports"
        else
            printf "%-35s ${RED}%-12s${NC} %-20s\n" "$svc" "‚óã STOPPED" "-"
        fi
    done
    
    echo ""
}

build_all() {
    print_header
    echo -e "${YELLOW}Building all images...${NC}\n"
    
    for svc in "${APP_SERVICES[@]}"; do
        if [ "$svc" != "zimmer-14-worker" ]; then
            echo -e "${BLUE}‚Üí${NC} Building $svc..."
            "$SCRIPT_DIR/${svc}.sh" build
        fi
    done
    
    echo -e "${BLUE}‚Üí${NC} Building zimmer-14-worker..."
    "$SCRIPT_DIR/zimmer-14-worker.sh" build
    
    echo -e "\n${GREEN}‚úì All images built${NC}"
}

show_help() {
    print_header
    echo "Usage: $0 <command> [service]"
    echo ""
    echo "Global Commands:"
    echo "  start       Start all services (infra first, then apps)"
    echo "  stop        Stop all services gracefully"
    echo "  restart     Restart all services"
    echo "  status      Show status of all services"
    echo "  build       Build all Docker images"
    echo ""
    echo "Single Service Commands:"
    echo "  start <service>    Start specific service"
    echo "  stop <service>     Stop specific service"
    echo "  logs <service>     Show logs for service"
    echo ""
    echo "Available Services:"
    echo "  Infrastructure: ${INFRA_SERVICES[*]}"
    echo "  Applications:   ${APP_SERVICES[*]}"
    echo ""
    echo "Examples:"
    echo "  $0 start                    # Start everything"
    echo "  $0 start zimmer-09-clawdbot # Start only ClawdBot"
    echo "  $0 logs zimmer-13-api       # View API logs"
    echo "  $0 status                   # Show all status"
    echo ""
}

case "${1:-help}" in
    start)
        if [ -n "$2" ]; then
            "$SCRIPT_DIR/${2}.sh" start
        else
            start_all
        fi
        ;;
    stop)
        if [ -n "$2" ]; then
            "$SCRIPT_DIR/${2}.sh" stop
        else
            stop_all
        fi
        ;;
    restart)
        if [ -n "$2" ]; then
            "$SCRIPT_DIR/${2}.sh" restart
        else
            stop_all
            sleep 3
            start_all
        fi
        ;;
    status)  show_status ;;
    build)   build_all ;;
    logs)
        if [ -n "$2" ]; then
            "$SCRIPT_DIR/${2}.sh" logs "${3:-100}"
        else
            echo "Usage: $0 logs <service>"
        fi
        ;;
    *)       show_help ;;
esac
