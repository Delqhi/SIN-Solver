version: '3.9'

services:
  solver-2.1-survey-worker:
    image: sin-solver-zimmer-18-survey-worker:latest
    container_name: solver-2.1-survey-worker
    ports:
      - "8018:8000"
    environment:
      - NODE_ENV=production
      - SURVEY_LOG_LEVEL=${LOG_LEVEL:-info}
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@room-03-postgres-master:5432/${DB_NAME}
      - REDIS_URL=redis://room-04-redis-cache:6379
      - SOLVER_NAME=survey-worker
      - SOLVER_ID=2.1
      - SOLVER_ROLE=survey-completion
      - SOLVER_VERSION=1.0.0
      - MAX_CONCURRENT_SURVEYS=${SOLVER_2_1_MAX_CONCURRENT:-5}
      - SURVEY_TIMEOUT=${SOLVER_2_1_TIMEOUT:-600}
      - PLATFORMS=${SURVEY_PLATFORMS:-swagbucks,prolific,mturk}
      - AI_PROVIDER=${AI_PROVIDER:-opencode}
      - OPENCODE_API_KEY=${OPENCODE_API_KEY}
      - CAPTCHA_SOLVER_URL=http://solver-1.1-captcha-worker:8000
       - BROWSER_POOL_SIZE=${SURVEY_BROWSER_POOL:-3}
    networks:
      - sin-solver-network
    volumes:
      - solver-2.1-data:/app/data
      - solver-2.1-cache:/app/.cache
      - solver-2.1-logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:8000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=solver-2.1-survey"
    labels:
      - "com.sin-solver.service=solver"
      - "com.sin-solver.solver-id=2.1"
      - "com.sin-solver.solver-role=survey-completion"
      - "com.sin-solver.version=1.0"

volumes:
  solver-2.1-data:
    driver: local
  solver-2.1-cache:
    driver: local
  solver-2.1-logs:
    driver: local

networks:
  sin-solver-network:
    external: true
    name: sin-solver-network
