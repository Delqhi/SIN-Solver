# AlertManager Configuration for SIN-Solver CAPTCHA System
# Version: 2026.1.0
# 
# Routing:
#   - Critical alerts: Immediate notification (PagerDuty, SMS, Email)
#   - Warning alerts: Standard notification (Slack, Email)
#   - Info alerts: Low priority (Slack only)

global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@sin-solver.io'
  smtp_auth_username: 'alerts@sin-solver.io'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Slack webhook (configure with actual webhook URL)
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # PagerDuty service key
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
  
  # Resolve timeout
  resolve_timeout: 5m

# Templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing tree
route:
  group_by: ['alertname', 'cluster', 'service', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default'
  
  routes:
    # Critical alerts - immediate paging
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 5m
      continue: true
    
    # Platform team alerts
    - match:
        team: platform
      receiver: 'platform-team'
      routes:
        - match:
            severity: critical
          receiver: 'platform-critical'
    
    # ML team alerts
    - match:
        team: ml
      receiver: 'ml-team'
    
    # Security team alerts
    - match:
        team: security
      receiver: 'security-team'
    
    # Business alerts
    - match:
        team: revenue
      receiver: 'revenue-team'
    
    # CAPTCHA service alerts
    - match:
        service: captcha
      receiver: 'captcha-alerts'
      group_by: ['alertname', 'captcha_type']
    
    # Info alerts - low priority
    - match:
        severity: info
      receiver: 'info-alerts'
      group_interval: 30m
      repeat_interval: 24h

# Receivers
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{% raw %}{{ template "slack.default.title" . }}{% endraw %}'
        text: '{% raw %}{{ template "slack.default.text" . }}{% endraw %}'

  - name: 'critical-alerts'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: critical
        description: '{% raw %}{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}{% endraw %}'
        details:
          firing: '{% raw %}{{ template "pagerduty.default.description" . }}{% endraw %}'
          resolved: '{% raw %}{{ template "pagerduty.default.instances" . }}{% endraw %}'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        title: 'üö® CRITICAL: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: |
          {% raw %}{{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Instance:* {{ .Labels.instance }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}{% endraw %}
    email_configs:
      - to: 'oncall@sin-solver.io'
        send_resolved: true
        subject: '[CRITICAL] SIN-Solver Alert: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        body: |
          {% raw %}{{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Instance: {{ .Labels.instance }}
          Time: {{ .StartsAt }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}{% endraw %}

  - name: 'platform-team'
    slack_configs:
      - channel: '#platform-alerts'
        send_resolved: true
        title: 'Platform: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ template "slack.default.text" . }}{% endraw %}'

  - name: 'platform-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_PLATFORM_KEY}'
        severity: critical
    slack_configs:
      - channel: '#platform-critical'
        send_resolved: true

  - name: 'ml-team'
    slack_configs:
      - channel: '#ml-alerts'
        send_resolved: true
        title: 'ML: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ template "slack.default.text" . }}{% endraw %}'

  - name: 'security-team'
    slack_configs:
      - channel: '#security-alerts'
        send_resolved: true
        title: 'üîí Security: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: '{% raw %}{{ template "slack.default.text" . }}{% endraw %}'
    email_configs:
      - to: 'security@sin-solver.io'
        send_resolved: true

  - name: 'revenue-team'
    slack_configs:
      - channel: '#revenue-alerts'
        send_resolved: true
        title: 'üí∞ Revenue: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'

  - name: 'captcha-alerts'
    slack_configs:
      - channel: '#captcha-alerts'
        send_resolved: true
        title: 'CAPTCHA: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'
        text: |
          {% raw %}{{ range .Alerts }}
          *Type:* {{ .Labels.captcha_type }}
          *Status:* {{ .Labels.status }}
          *Solver:* {{ .Labels.solver }}
          *Summary:* {{ .Annotations.summary }}
          {{ end }}{% endraw %}

  - name: 'info-alerts'
    slack_configs:
      - channel: '#info-alerts'
        send_resolved: true
        title: '‚ÑπÔ∏è Info: {% raw %}{{ .GroupLabels.alertname }}{% endraw %}'

# Inhibition rules (prevent alert spam)
inhibit_rules:
  # Inhibit warning alerts if critical exists for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
  
  # Inhibit info alerts if warning exists
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'cluster', 'service']

# Time intervals for muting (maintenance windows)
time_intervals:
  - name: maintenance_windows
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['sunday']
        location: 'Europe/Berlin'
