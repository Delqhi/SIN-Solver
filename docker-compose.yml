# ðŸš€ SIN-SOLVER: DAS HAUS (CEO EMPIRE STATE EDITION 2026)
# Standard: Enterprise Browser Automation (Steel + Vision + SurfSense)

services:
  # ==========================================
  # EBENE 5: INFRASTRUKTUR (Fundament)
  # ==========================================
  
  room-04-redis-cache:
    image: redis:7.2-alpine
    container_name: room-04-redis-cache
    command: redis-server --save 60 1 --loglevel warning
    ports: ["6379:6379"]
    volumes: [redis_data:/data]
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.10
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  room-03-postgres-master:
    image: postgres:15-alpine
    container_name: room-03-postgres-master
    environment:
      POSTGRES_DB: sin_solver_production
      POSTGRES_USER: ceo_admin
      POSTGRES_PASSWORD: secure_ceo_password_2026
    ports: ["5432:5432"]
    volumes: [postgres_data:/var/lib/postgresql/data]
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.11
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ceo_admin -d sin_solver_production"]
      interval: 5s
      timeout: 5s
      retries: 5

  room-10-postgres-knowledge:
    image: postgres:15-alpine
    container_name: room-10-postgres-knowledge
    environment:
      POSTGRES_DB: knowledge_base
      POSTGRES_USER: librarian
      POSTGRES_PASSWORD: secure-knowledge-2026
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.12
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U librarian -d knowledge_base"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ==========================================
  # EBENE 4: BROWSER (The Muscle)
  # ==========================================

  agent-05-steel-browser:
    image: ghcr.io/steel-dev/steel-browser:latest
    container_name: agent-05-steel-browser
    ports: 
      - "3000:3000"
      - "9222:9222"
    environment:
      PORT: 3000
      DEBUGGER_PORT: 9222
      STEALTH_MODE: "true"
      CONCURRENCY: 10
    volumes:
      - steel_data:/home/pptruser/.config/google-chrome
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.20
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================
  # EBENE 3: MANAGEMENT & WORKFLOW
  # ==========================================

  agent-01-n8n-orchestrator:
    image: n8nio/n8n:latest
    container_name: agent-01-n8n-orchestrator
    ports: ["5678:5678"]
    environment:
      N8N_SECURE_COOKIE: "false"
      N8N_BLOCK_IFRAMES: "false"
      N8N_EDITOR_BASE_URL: http://192.168.178.21:5678/
      N8N_USE_SAMESITE_COOKIE: "none"
      WEBHOOK_URL: http://192.168.178.21:5678/
    volumes: [n8n_data:/home/node/.n8n]
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.30
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5

  room-13-fastapi-coordinator:
    build:
      context: ./services/room-13-fastapi-coordinator
      dockerfile: Dockerfile
    container_name: room-13-fastapi-coordinator
    env_file: .env
    environment:
      POSTGRES_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-default-key-change}
      JWT_SECRET: ${JWT_SECRET:-default-jwt-secret-change}
    ports: ["8000:8000"]
    depends_on:
      room-04-redis-cache: { condition: service_healthy }
      room-03-postgres-master: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.31
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================
  # EBENE 2: INTERFACES
  # ==========================================

  room-11-dashboard-cockpit:
    build:
      context: ./services/room-11-dashboard-cockpit
      dockerfile: Dockerfile
    container_name: room-11-dashboard-cockpit
    environment:
      NODE_ENV: production
      API_URL: http://room-13-fastapi-coordinator:8000
    ports: ["3001:80"]
    depends_on:
      room-13-fastapi-coordinator: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.40
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  agent-04-opencode-secretary:
    build:
      context: ./services/agent-04-opencode-secretary
      dockerfile: Dockerfile
    container_name: agent-04-opencode-secretary
    environment:
      NODE_ENV: production
      PORT: 9000
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
    ports: ["3002:9000"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.41
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # EBENE 1: AGENTS & WORKERS
  # ==========================================

  agent-03-agentzero-coder:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.agentzero
    container_name: agent-03-agentzero-coder
    command: python app/core/CEO_STEEL_MASTER_WORKER.py
    ports: ["5001:8000"]
    environment:
      PYTHONPATH: .
      ROLE: master_agent
      STEEL_CDP_URL: ws://172.20.0.20:3000/
      DATABASE_URL: postgresql+asyncpg://ceo_admin:secure_ceo_password_2026@172.20.0.11:5432/sin_solver_production
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.50

  agent-06-skyvern-solver:
    image: skyvern/skyvern:latest
    container_name: agent-06-skyvern-solver
    ports: ["8002:8000"]
    environment:
      DATABASE_STRING: postgresql+asyncpg://librarian:secure-knowledge-2026@172.20.0.12:5432/knowledge_base
      BROWSER_TYPE: cdp-connect
      BROWSER_URL: http://172.20.0.20:3000
      LLM_KEY: OPENAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      room-10-postgres-knowledge: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.51

  agent-07-stagehand-research:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.worker
    container_name: agent-07-stagehand-research
    command: python app/core/CEO_STEEL_MASTER_WORKER.py
    ports: ["8003:8000"]
    environment:
      ROLE: researcher
      PYTHONPATH: .
      STEEL_CDP_URL: ws://172.20.0.20:3000/
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.54

  solver-14-worker-automation:
    build:
      context: ./services/solver-14-worker-automation
      dockerfile: Dockerfile
    restart: always
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
      STEEL_CDP_URL: ws://agent-05-steel-browser:3000/
      CONCURRENT_TASKS: 3
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks: [haus-netzwerk]
    deploy:
      replicas: 5
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  agent-02-chronos-scheduler:
    build:
      context: ./services/agent-02-chronos-scheduler
      dockerfile: Dockerfile
    container_name: agent-02-chronos-scheduler
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      API_BRAIN_URL: http://room-13-fastapi-coordinator:8000
    ports: ["3001:3001"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-13-fastapi-coordinator: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.52
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  agent-09-clawdbot-messenger:
    build:
      context: ./services/agent-09-clawdbot-messenger
      dockerfile: Dockerfile
    container_name: agent-09-clawdbot-messenger
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
    ports: ["8004:8080"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.55
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agent 08: Playwright Tester (Automated Testing & Quality Assurance)
  agent-08-playwright-tester:
    build:
      context: ./services/agent-08-playwright-tester
      dockerfile: Dockerfile
    container_name: agent-08-playwright-tester
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
    ports: ["8005:8080"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.56
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  room-17-sin-plugins:
    build:
      context: ./services/room-17-sin-plugins
      dockerfile: Dockerfile
    container_name: room-17-sin-plugins
    environment:
      NODE_ENV: production
      PORT: 8000
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
    ports: ["8006:8000"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.57
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  agent-12-evolution-optimizer:
    build:
      context: ./services/agent-12-evolution-optimizer
      dockerfile: Dockerfile
    container_name: agent-12-evolution-optimizer
    environment:
      NODE_ENV: production
      PORT: 8080
      DATABASE_URL: postgresql://ceo_admin:secure_ceo_password_2026@room-03-postgres-master:5432/sin_solver_production
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
    ports: ["8007:8080"]
    depends_on:
      room-03-postgres-master: { condition: service_healthy }
      room-04-redis-cache: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.53
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  solver-18-survey-worker:
    build:
      context: ./services/solver-18-survey-worker
      dockerfile: Dockerfile
    container_name: solver-18-survey-worker
    environment:
      NODE_ENV: production
      PORT: 8018
      REDIS_URL: redis://room-04-redis-cache:6379
      API_COORDINATOR_URL: http://room-13-fastapi-coordinator:8000
      STEEL_CDP_URL: ws://agent-05-steel-browser:3000/
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      OPENCODE_ZEN_API_KEY: ${OPENCODE_ZEN_API_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      HUGGINGFACE_API_KEY: ${HUGGINGFACE_API_KEY}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    ports: ["8018:8018"]
    depends_on:
      room-04-redis-cache: { condition: service_healthy }
      agent-05-steel-browser: { condition: service_healthy }
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.80
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8018/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Room 15 (AI Research Knowledge Base)
  room-15-surfsense-archiv:
    image: ghcr.io/modsetter/surfsense:latest
    container_name: room-15-surfsense-archiv
    ports: ["3003:3000", "8000:8000"]
    environment:
      NEXT_PUBLIC_BACKEND_URL: http://192.168.178.21:8000
    volumes:
      - surfsense_data:/data
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.60
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Room 16: Supabase Studio (Database GUI)
  room-16-supabase-studio:
    image: supabase/studio:latest
    container_name: room-16-supabase-studio
    ports: ["3004:3000"]
    environment:
      STUDIO_PG_META_URL: http://room-16-pg-meta:8080/pg
      POSTGRES_PASSWORD: secure_ceo_password_2026
      SUPABASE_URL: http://172.20.0.11:8000
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.70

  # Room 16.1: PG-META (Requirement for Studio)
  room-16-pg-meta:
    image: supabase/postgres-meta:v0.95.1
    container_name: room-16-pg-meta
    environment:
      PG_META_DB_URL: postgres://ceo_admin:secure_ceo_password_2026@172.20.0.11:5432/sin_solver_production
    networks:
      haus-netzwerk:
        ipv4_address: 172.20.0.71

  # Zimmer 99: Terminal Removed for stability during initialization

networks:
  haus-netzwerk:
    name: haus-netzwerk
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
  postgres_data:
  knowledge_data:
  n8n_data:
  surfsense_data:
  steel_data:
